(()=>{var e={202:()=>{$.component("AerialView",{width:160,minimize:!1,getTpl:function(){return'<span class="fas fa-angle-up minimize" role="button"></span><div class="viewport"></div><div class="thumbnails"></div>'},init:function(){let e=this,t=e.dom,d=e.diagram.canvas,o=d.parent();t.append(e.getTpl()),e.viewport=t.find(".viewport"),e.thumbnail=t.find(".thumbnails");let n=!1,i=function(t){n=!0;let i=e.diagram.zoom/100,a=d.width()*i,s=o.width(),l=a>s?a/e.width:s/e.width;o.scrollLeft(t.position.left*l),o.scrollTop(t.position.top*l),n=!1};e.viewport.draggable({containment:"parent",drag:function(e,t){i(t)},stop:function(e,t){i(t)}}),t.on("click",".minimize",(function(){let d=$(this);e.minimize?(d.removeClass("fa-angle-down").addClass("fa-angle-up"),t.find(".viewport,.thumbnails").show(),e.minimize=!1,e.updateView()):(d.removeClass("fa-angle-up").addClass("fa-angle-down"),t.find(".viewport,.thumbnails").hide(),t.width(20).height(20),e.minimize=!0)})),$(window).on("resize",(function(){e.updateView()})),e.diagram.onZoom((function(){e.updateView()})),o.scroll((function(){if(!n&&!e.minimize){let t=e.diagram.zoom/100,n=d.width()*t,i=o.width(),a=n>i?e.width/n:e.width/i;e.viewport.css("top",o.scrollTop()*a).css("left",o.scrollLeft()*a)}})),e.minimize?(m.removeClass("fa-angle-up").addClass("fa-angle-down"),t.find(".viewport,.thumbnails").hide(),t.width(20).height(20)):e.updateView()},updateView:function(){let e=this;if(e.minimize)return;let t=e.dom,d=e.diagram.canvas,o=d.parent(),n=e.diagram.zoom/100,i=d.width()*n,a=d.height()*n,s=o.width(),l=o.height(),c=i>s?e.width/i:e.width/s,r=i>s?c*s:e.width,m=a>l?r*l/s:c*a;t.width(e.width+2),t.height(c*a+2),e.viewport.height(m).width(r).css("top",o.scrollTop()*c).css("left",o.scrollLeft()*c),i>s?e.thumbnail.css("zoom",100*e.width/d.width()+"%"):e.thumbnail.css("zoom",100*e.width/d.width()*i/s+"%")},load:function(){let e=this;e.thumbnail.empty(),e.diagram.models.each((function(){e.add(this.id)}))},update:function(e){let t=this.diagram.canvas.find("#"+e);this.thumbnail.find("[data-id="+e+"]").height(t.height()).width(t.width()).css("top",t.css("top")).css("left",t.css("left"))},add:function(e){let t=this.diagram.canvas.find("#"+e);this.thumbnail.append('<div class="model-thumbnail" data-id="'+e+'" style="height:'+t.height()+"px;width:"+t.width()+"px;top:"+t.css("top")+";left:"+t.css("left")+';"></div>')},remove:function(e){this.thumbnail.find("[data-id="+e+"]").remove()}})},441:()=>{jdoo.component("CommandMemo",{init:function(){let e=this;e.observer=[],e.undoStack=[],e.redoStack=[],e.onChange(e.change)},add:function(e){let t=this;t.redoStack=[],t.undoStack.push(e),t.triggerChange()},clear:function(){let e=this;e.undoStack=[],e.redoStack=[],e.triggerChange()},clearRedo:function(){this.redoStack=[],this.triggerChange()},clearUndo:function(){this.undoStack=[],this.triggerChange()},undo:function(){let e=this;if(e.undoStack.length>0){let t=e.undoStack.pop();return t.undo(),e.redoStack.push(t),e.triggerChange(),t}},redo:function(){let e=this;if(e.redoStack.length>0){let t=e.redoStack.pop();return t.redo(),e.undoStack.push(t),e.triggerChange(),t}},canRedo:function(){return this.redoStack.length>0},canUndo:function(){return this.undoStack.length>0},triggerChange:function(){let e=this;$.each(e.observer,(function(){this(e)}))},onChange:function(e){this.observer.push(e)}})},718:()=>{jdoo.component("Connector",{getTpl:function(){return'<svg id="'+this.id+'" pointer-events="none" version="1.1" xmlns="http://www.w3.org/2000/svg" class="model-connector">                    <path id="path-'+this.id+'" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="#456" stroke-width="2"></path>                </svg>                <svg id="start-point-'+this.id+'" width="16" height="16" pointer-events="none" version="1.1" xmlns="http://www.w3.org/2000/svg" class="connector-endpoint">                    <circle cx="8" cy="8" r="8" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="#f76258" stroke="none"></circle>                </svg>                <svg id="end-point-'+this.id+'" width="16" height="16" pointer-events="none" version="1.1" xmlns="http://www.w3.org/2000/svg" class="connector-endpoint">                    <circle cx="8" cy="8" r="8" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="#f76258" stroke="none"></circle>                </svg>                <div id="start-note-'+this.id+'" class="connector-note">'+("one2many"===this.type?"1":"N")+'</div>                <div id="end-note-'+this.id+'" class="connector-note">'+("many2one"===this.type?"1":"N")+"</div>"},init:function(){let e=this;e.id=e.id||jdoo.utils.randomId(),e.canvas=$(e.renderTo),e.canvas.append(e.getTpl()),e.svg=e.canvas.find("#"+e.id),e.path=e.canvas.find("#path-"+e.id),e.startPoint=e.canvas.find("#start-point-"+e.id),e.endPoint=e.canvas.find("#end-point-"+e.id),e.startNote=e.canvas.find("#start-note-"+e.id),e.endNote=e.canvas.find("#end-note-"+e.id),e._from=$(e.from),e._to=$(e.to),e.canvasParent=e.canvas.parent(),e.update()},update:function(){let e=this,t=e._from.offset(),d=e._to.offset(),o=e.canvas.offset(),n={x:t.left-o.left,y:t.top-o.top,h:e._from.height(),w:e._from.width()},i={x:d.left-o.left,y:d.top-o.top,h:e._to.height(),w:e._to.width()};n.p=n.y+n.h/2,i.p=i.y+i.h/2;let a={};n.p>i.p?(e.svg.css("top",i.p-10+"px"),a.y1=n.p-i.p+10,a.y2=10):(e.svg.css("top",n.p-10+"px"),a.y1=10,a.y2=i.p-n.p+10);let s=-Math.min(40,Math.floor(Math.abs(a.y1-a.y2)/10));Math.abs(n.x-i.x)<50?(n.x<i.x?(e.svg.css("left",n.x-45+"px"),e.svg.width(80),a.x1=30,a.x2=i.x-n.x+30):(e.svg.css("left",i.x-45+"px"),e.svg.width(80),a.x1=n.x-i.x+30,a.x2=30),e.startPoint.css("left",n.x-20+"px"),e.endPoint.css("left",i.x-20+"px"),e.startNote.css("left",n.x-20+"px"),e.endNote.css("left",i.x-20+"px")):n.x+n.w<i.x?(e.svg.css("left",n.x+n.w-40+"px"),e.svg.width(i.x-n.x-n.w+80),e.startPoint.css("left",n.x+n.w+5+"px"),e.endPoint.css("left",i.x-20+"px"),e.startNote.css("left",n.x+n.w+5+"px"),e.endNote.css("left",i.x-20+"px"),a.x1=55,a.x2=i.x-n.x-n.w+25,a.y1<a.y2&&(s*=-1)):i.x+i.w<n.x?(e.svg.css("left",i.x+i.w-40+"px"),e.svg.width(n.x-i.x-i.w+80),e.startPoint.css("left",n.x-20+"px"),e.endPoint.css("left",i.x+i.w+5+"px"),e.startNote.css("left",n.x-20+"px"),e.endNote.css("left",i.x+i.w+5+"px"),a.x1=n.x-i.x-i.w+25,a.x2=55,a.y1>a.y2&&(s*=-1)):n.x<i.x?(e.svg.css("left",i.x-40+"px"),e.svg.width(n.x+n.w-i.x+80),e.startPoint.css("left",n.x+n.w+5+"px"),e.endPoint.css("left",i.x-20+"px"),e.startNote.css("left",n.x+n.w+5+"px"),e.endNote.css("left",i.x-20+"px"),a.x1=n.x+n.w-i.x+55,a.x2=25):(e.svg.css("left",n.x-40+"px"),e.svg.width(i.x+i.w-n.x+80),e.startPoint.css("left",n.x-20+"px"),e.endPoint.css("left",i.x+i.w+5+"px"),e.startNote.css("left",n.x-20+"px"),e.endNote.css("left",i.x+i.w+5+"px"),a.x2=i.x+i.w-n.x+55,a.x1=25),e.startPoint.css("top",n.y+n.h/2-8+"px"),e.endPoint.css("top",i.y+i.h/2-8+"px"),e.startNote.css("top",n.y+n.h/2-9.5+"px"),e.endNote.css("top",i.y+i.h/2-9.5+"px"),e.svg.height(Math.abs(n.y+n.h/2-(i.y+i.h/2))+20);let l=(a.x1+a.x2)/2+s,c=(a.y1+a.y2)/2+s;e.path.attr("d","M "+a.x1+" "+a.y1+" C "+l+" "+c+" "+l+" "+c+" "+a.x2+" "+a.y2)}})},969:()=>{$.component("Diagram",{model:"modeling.diagram",module:"modeling",width:2e3,height:2e3,getTpl:function(){return`<div class="tool-bar">\n                    <button title="${"刷新".t()}" class="btn btn-default btn-sm btn-reload">\n                        <span class="fas fa-sync-alt"></span>\n                    </button>\n                    <button title="${"撤销".t()}" class="btn btn-default btn-sm btn-undo">\n                        <span class="fas fa-undo-alt"></span>\n                    </button>\n                    <button title="${"恢复".t()}" class="btn btn-default btn-sm btn-redo">\n                        <span class="fas fa-redo-alt"></span>\n                    </button>\n                    <button title="${"查看代码".t()}" class="btn btn-default btn-sm btn-code-view">\n                        <span class="fas fa-laptop-code"></span>\n                    </button>\n                    <button title="${"下载代码".t()}" class="btn btn-default btn-sm btn-code-down">\n                        <span class="fas fa-download"></span>\n                    </button>\n                    <button title="${"从源码包生成模型图".t()}" class="btn btn-default btn-sm btn-reflact">\n                        <span class="fas fa-gg"></span>\n                    </button>\n                    <div title="${"缩放".t()}" class="zoom-slider">\n                        <div></div>\n                    </div>\n                </div>\n                <div class="model-diagram" tabindex="-1">\n                    <div class="tool-panel">\n                        <div class="tool-item ui-draggable ui-draggable-handle" data="model">\n                            <i class="tool-icon mr-1 fa fa-medium-m"></i>模型\n                        </div >\n                        <div class="tool-item ui-draggable ui-draggable-handle" data="memo">\n                            <i class="tool-icon mr-1 fa fa-sticky-note"></i>备注\n                        </div>\n                    </div >\n                    <div class="aerial-view"></div>\n                    <div class="drag-container">\n                        <div class="diagram-panel">\n                            <div id="'+ this.id + '" class="model-canvas container-fluid">\n                            </div>\n                        </div>\n                    </div>\n                </div>`},init:function(){let e=this,t=e.dom;t.append(e.getTpl()),e.zoom=100,e.zoomSlider=t.find(".zoom-slider div").bootstrapSlider({formatter:function(e){return e>=5?e/5*100+"%":15*e+25+"%"},width:"100px"}),e.zoomSlider.on("change",(function(d){let o=d.value.newValue;o>=5&&(e.zoom=o/5*100),e.zoom=15*o+25,e.canvas.css("zoom",e.zoom+"%"),t.triggerHandler("zoom",[e])})),e.models=jdoo.create("KeyValue"),e.canvas=t.find(".model-canvas").height(e.height).width(e.width),e.cmdMemo=jdoo.create("CommandMemo",{change:function(e){t.find(".btn-redo").attr("disabled",!e.canRedo()),t.find(".btn-undo").attr("disabled",!e.canUndo())}}),t.on("click",".item-model",(function(t){let d=$(this).attr("id"),o=e.models.get(d);t.ctrlKey?o.selected?o.unselect():o.select():(e.models.each((function(){this.unselect()})),o.select())})).on("click",".btn-undo",(function(t){e.cmdMemo.undo()})).on("click",".btn-reload",(function(t){e.load()})).on("click",".btn-redo",(function(t){e.cmdMemo.redo()})).on("click",".btn-code-view",(function(t){let d=[];e.models.each((function(){this.selected&&d.push(this.data.id)})),e.viewCode(d)})).on("click",".btn-code-down",(function(t){let d=[];e.models.each((function(){this.selected&&d.push(this.data.id)})),window.open(jdoo.web.getTenantPath()+"/diagram/code?models="+d.join(),"_self")})).on("click",".btn-reflact",(function(t){jdoo.rpc({model:e.model,module:e.module,method:"reflect",args:{ids:[e.id]},onsuccess:function(t){e.load(),e.dom.triggerHandler("modelChanged",[e])}})})),t.find(".model-diagram").keydown((function(t){t.ctrlKey&&65==t.keyCode&&(e.selectModels(),t.stopPropagation(),t.cancelBubble=!0,t.preventDefault())})).focus(),e.onModelChanged(e.modelChange),e.tools=e.dom.find(".tool-item").ToolItem({diagram:e,containment:e.dom.find(".drag-container")}),e.aerialView=e.dom.find(".aerial-view").AerialView({diagram:e}),e.load()},updateSize:function(e){this.canvas.width(e.width).height(e.height),this.aerialView.updateView()},onZoom:function(e){this.dom.on("zoom",e)},onModelChanged:function(e){this.dom.on("modelChanged",e)},deleteModel:function(e,t){let d=this,o=d.models.get(e),n=$.extend({},o.data);n.x=o.x,n.y=o.y;let i=function(){let t=d.models.get(e);t&&jdoo.rpc({model:d.model,module:d.module,method:"deleteModel",args:{modelId:t.data.id},onsuccess:function(t){let o=d.removeModel(e);d.dom.triggerHandler("modelChanged",[d,o])}})};t||d.cmdMemo.add({undo:function(){d.saveModel("addModel",n,{success:function(t){let o=$.extend({},{data:n});o.id=e,o.data.id=t.data,o.x=n.x,o.y=n.y;let i=d._addModel(o);d.dom.triggerHandler("modelChanged",[d,i]),d.updateConnectors()}})},redo:function(){i()}}),i()},unlinkModel:function(e,t){let d=this,o=d.models.get(e).data,n=function(){jdoo.rpc({model:d.model,module:d.module,method:"unlinkModel",args:{ids:[d.id],modelId:d.models.get(e).data.id},onsuccess:function(t){d.removeModel(e)}})};t||d.cmdMemo.add({undo:function(){d.linkModel(o,!0)},redo:function(){n()}}),n()},removeModel:function(e){let t=this,d=t.models.remove(e);return t.canvas.find("#"+e).remove(),t.updateConnectors(),t.aerialView.remove(e),d},linkModel:function(e,t){let d=this,o=d.models.get(e.id);if(o)return jdoo.msg.error({code:1e3,message:"模型已存在"},"警告"),o;let n=function(){jdoo.rpc({model:d.model,module:d.module,method:"linkModel",args:{ids:[d.id],modelId:e.dataId,x:String(e.x),y:String(e.y)},onsuccess:function(e){let t=e.data,n=t.fields;delete t.fields,o=d._addModel(t),$.each(n,(function(){o.addField(this)})),d.updateConnectors()}})};t||d.cmdMemo.add({undo:function(){d.unlinkModel(e.id,!0)},redo:function(){n()}}),n()},_addModel:function(e){let t=this;e.diagram=t,e.renderTo=t.canvas;let d=jdoo.create("Model",e);return t.models.add(d.id,d),t.aerialView.add(d.id),d},saveModel:function(e,t,d){let o=this;jdoo.rpc({model:o.model,module:o.module,method:e,args:{ids:[o.id],values:t},onerror:function(e){d&&d.error&&d.error(e),jdoo.msg.error(e)},onsuccess:function(e){d&&d.success&&d.success(e)}})},addModel:function(e,t){let d=this;jdoo.rpc({model:d.model,module:d.module,method:"addModel",args:{ids:[d.id],values:e},onerror:function(e){t&&t.error&&t.error(e),jdoo.msg.errpr(e)},onsuccess:function(o){e.dataId=o.data;let n=d._addModel($.extend({},e));d.dom.triggerHandler("modelChanged",[d,n]),d.updateConnectors(),t&&t.success&&t.success(o)}})},newModel:function(e){let t=this,d=jdoo.utils.randomId();t.modelEditor.edit({submit:function(o){if(o.form.valid()){o.busy(!0);let n=o.form.getData();n.x=e.x,n.y=e.y;let i=function(e){let o=$.extend({},{data:n});o.id=d,o.data.id=e.data,o.data.module_id=t.module_id,o.x=n.x,o.y=n.y;let i=t._addModel(o);t.dom.triggerHandler("modelChanged",[t,i]),t.updateConnectors()};t.saveModel("addModel",n,{error:function(e){o.busy(!1)},success:function(e){i(e),o.close()}}),t.cmdMemo.add({undo:function(){t.deleteModel(d,!0)},redo:function(){t.saveModel("addModel",n,{success:function(e){i(e)}})}})}}})},editModel:function(e){let t=this;t.modelEditor.edit({id:t.models.get(e).data.id,submit:function(d){if(d.form.valid()){d.busy(!0);let o=d.form.getData(),n=t.modelEditor.data;o.id=t.models.get(e).data.id;let i=function(d){let o=t.models.get(e);o.update(d),t.dom.triggerHandler("modelChanged",[t,o]),t.updateConnectors()};t.saveModel("updateModel",o,{error:function(e){d.busy(!1)},success:function(e){i(o),d.close()}}),t.cmdMemo.add({undo:function(){n.id=t.models.get(e).data.id,t.saveModel("updateModel",n,{success:function(e){i(n)}})},redo:function(){t.saveModel("updateModel",o,{success:function(e){i(o)}})}})}}})},deleteField:function(e,t){let d=this,o=d.models.get(e),n=$.extend({},o.fields.get(t).data);n.model_id=o.data.id;let i=function(){let o=d.models.get(e),n=o.fields.get(t).data.id;d.saveField("updateModel",{id:o.id(),field_ids:[[2,n]]},{success:function(e){o.removeField(t),d.updateConnectors(),d.aerialView.update(o.id())}})};d.cmdMemo.add({undo:function(){d.saveField("addModelField",n,{success:function(i){let a=$.extend({},n);a.id=t,a.dataId=i.data,d.models.get(e).addField(a),d.updateConnectors(),d.aerialView.update(o.id())}})},redo:function(){i()}}),i()},createField:function(e){let t=this,d=t.models.get(e),o=jdoo.utils.randomId();t.fieldEditor.edit({submit:function(n){if(n.form.valid()){n.busy(!0);let i=n.form.getData();i.model_id=d.data.id;let a=function(d){let n=$.extend({},{data:i});n.id=o,n.data.id=d.data,t.models.get(e).addField(n),t.updateConnectors(),t.aerialView.update(e)};t.cmdMemo.add({undo:function(){let d=t.models.get(e);t.saveField("updateModel",{id:d.data.id,field_ids:[[2,d.fields.get(o).data.id]]},{success:function(n){d.removeField(o),t.updateConnectors(),t.aerialView.update(e)}})},redo:function(){t.saveField("addModelField",i,{success:function(e){a(e)}})}}),t.saveField("addModelField",i,{success:function(e){a(e),n.close()},error:function(e){n.busy(!1)}})}}})},editField:function(e,t){let d=this,o=d.models.get(e),n=o.fields.get(t).data;d.fieldEditor.edit({id:n.dataId,submit:function(i){if(i.form.valid()){i.busy(!0);let a={},s=i.form.getData(),l={},c={};a.id=l.id=o.id(),a.field_ids=[[1,n.dataId,s]],$.extend(c,d.fieldEditor.data);let r=function(o,n){d.models.get(e).fields.get(t).update(n),d.updateConnectors(),d.aerialView.update(e)};d.cmdMemo.add({undo:function(){l.field_ids=[[1,d.models.get(e).fields.get(t).data.id,d.fieldEditor.data]],d.saveField("updateModel",l,{success:function(e){r(e,c)}})},redo:function(){a.field_ids=[[1,d.models.get(e).fields.get(t).data.id,s]],d.saveField("updateModel",a,{success:function(e){r(e,s)}})}}),d.saveField("updateModel",a,{success:function(e){r(e,s),i.close()},error:function(e){i.busy(!1)}})}}})},saveField:function(e,t,d){jdoo.rpc({model:this.model,module:this.module,method:e,args:{values:t},onerror:function(e){d&&d.error&&d.error(e),jdoo.msg.error(e)},onsuccess:function(e){d&&d.success&&d.success(e)}})},updateLocation:function(e){let t=this,d=function(e){jdoo.rpc({model:t.model,module:t.module,method:"updateModelPosition",args:{ids:[t.id],modelId:e.modelId,x:String(e.x),y:String(e.y)},onerror:function(e){jdoo.msg.error(e)},onsuccess:function(d){t.aerialView.update(e.id)}})};t.cmdMemo.add({undo:function(){t.models.get(e.id).moveTo({x:e.x0,y:e.y0}),d({id:e.id,modelId:e.modelId,x:e.x0,y:e.y0})},redo:function(){t.models.get(e.id).moveTo({x:e.x,y:e.y}),d({id:e.id,modelId:e.modelId,x:e.x,y:e.y})}}),d(e)},viewCode:function(e){let t=this;jdoo.showDialog({title:"代码预览".t(),css:"modal-xl modal-code",init:function(d){jdoo.rpc({model:t.model,module:t.module,method:"getCode",args:{modelIds:e},onerror:function(e){jdoo.msg.error(e)},onsuccess:function(e){let t=d.body.JTabs({}),o=0;$.each(e.data,(function(){let e=this;t.openTab("code-"+o++,{title:e.name,init:function(t){let d=`<div class="row code-preview m-2">\n                                                    <div class="col-6 h-100">\n                                                        <span>模型</span>\n                                                        <pre class="h-100 border"><code class="h-100 hljs">${hljs.highlight(e.code,{language:"java"}).value}</code></pre>\n                                                    </div>\n                                                    <div class="col-6 h-100">\n                                                        <span>视图</span>\n                                                        <pre class="h-100 border"><code class="h-100 hljs">${hljs.highlight(e.view,{language:"xml"}).value}</code></pre>\n                                                    </div>\n                                                </div>`;t.append(d)}})}))}})}})},selectModels:function(){this.models.each((function(){this.select()}))},unselectModels:function(){this.models.each((function(){this.unselect()}))},load:function(){let e=this;e.models=jdoo.create("KeyValue"),e.canvas.empty(),jdoo.rpc({model:e.model,module:e.module,method:"load",args:{ids:[e.id]},onsuccess:function(t){$.each(t.data,(function(){let t=this,d=t.fields||[],o={};o.x=t.x,o.y=t.y,delete t.y,delete t.x,delete t.fields,o.data=t;let n=e._addModel(o);$.each(d,(function(){n.addField({data:this})}))})),e.updateConnectors(),e.aerialView.load(),e.cmdMemo.clear()}})},updateConnectors:function(){let e=this;e.canvas.find(".model-connector,.connector-endpoint,.connector-note").remove(),e.models.each((function(){this.connectors=[]})),e.models.each((function(){let t=this;t.fields.each((function(){let d=this;if("one2many"===d.data.field_type){let o=e.models.first((function(e){return e.data.model===d.data.relation}));if(o){let n,i=o.fields.first((function(e){return e.data.name===d.data.relation_field}));i?(n=jdoo.create("Connector",{renderTo:e.canvas,diagram:e,type:"one2many",from:e.canvas.find("#"+d.id),to:e.canvas.find("#"+i.id)}),i.inverse=!0):(console.warn(`模型[${t.data.model}]一对多[${d.data.name}]的关联字段[${d.data.relation_field}]在模型[${o.data.model}]中不存在`),n=jdoo.create("Connector",{renderTo:e.canvas,diagram:e,css:"warn",type:"one2many",from:e.canvas.find("#"+d.id),to:e.canvas.find("#"+o.id+" .model-name")})),t.connectors.push(n),o.connectors.push(n)}}else if("many2many"===d.data.field_type&&!this.inverse){let o=e.models.first((function(e){return e.data.model===d.data.relation}));if(o){let n,i=o.fields.first((function(e){let o=e.data;return"many2many"===o.field_type&&(o.relation_table===d.data.relation_table||o.relation===t.data.model)}));i?(n=jdoo.create("Connector",{renderTo:e.canvas,diagram:e,type:"many2many",from:e.canvas.find("#"+d.id),to:e.canvas.find("#"+i.id)}),i.inverse=!0):n=jdoo.create("Connector",{renderTo:e.canvas,diagram:e,type:"many2many",from:e.canvas.find("#"+d.id),to:e.canvas.find("#"+o.id+" .model-model")}),t.connectors.push(n),o.connectors.push(n)}}}))})),e.models.each((function(){let t=this;t.fields.each((function(){let d=this;if("many2one"===d.data.field_type&&!this.inverse){let o=e.models.first((function(e){return e.data.model===d.data.relation}));if(o){let n=jdoo.create("Connector",{renderTo:e.canvas,diagram:e,type:"many2one",from:e.canvas.find("#"+d.id),to:e.canvas.find("#"+o.id+" .model-name")});t.connectors.push(n),o.connectors.push(n)}}}))}))}})},737:()=>{jdoo.component("Field",{name:"field",field_type:"char",label:"字段",getTpl:function(){return`<div id="${this.id}" data-field="${this.data.id}" class="item-field">\n                    <div class="field-tools">\n                        <div class="nav-item dropdown">\n                            <span data-toggle="dropdown" role="button">\n                                <i class="fa fa-bars"></i>\n                            </span>\n                            <div class="dropdown-menu dropdown-menu-right">\n                                <span role="button" class="menu-edit-field dropdown-item">${"编辑".t()}</span>\n                                <span role="button" class="menu-delete-field dropdown-item">${"删除".t()}</span>\n                            </div>\n                        </div>\n                    </div>\n                    <span class="field-label">${this.data.label||""}</span>(<span class="field-name">${this.data.name}</span>:<span class="field-type">${this.data.field_type}</span>)\n            </div>`},init:function(){var e=this,t=$(e.renderTo);e.id=e.id||jdoo.utils.randomId(),t.append(e.getTpl()),e.dom=t.find("#"+e.id)},update:function(e){var t=this;e.id!==t.data.id&&$("[data-field="+t.data.id+"]").attr("data-field",e.id),$.extend(!0,t.data,e),$("[data-field="+t.data.id+"] .field-label").html(t.data.label),$("[data-field="+t.data.id+"] .field-name").html(t.data.name),$("[data-field="+t.data.id+"] .field-type").html(t.data.field_type)}})},706:()=>{jdoo.component("FormEdit",{module:"modeling",edit:function(e){let t=this;t.view?t.showDialog(t.view,e):jdoo.rpc({model:"ir.ui.view",method:"loadView",args:{model:t.model,type:"form"},onsuccess:function(d){t.view=d.data,t.showDialog(t.view,e)}})},showDialog:function(e,t){let d=this;jdoo.showDialog({title:t.title||d.title,init:function(){let o=this;o.form=o.body.JForm({model:d.model,module:d.module,fields:e.fields,arch:e.views.form.arch,ajax:function(e,n){t.id&&jdoo.rpc({model:d.model,module:d.module,method:"read",args:{ids:[t.id],fields:o.form.getFields()},context:{usePresent:!0},onsuccess:function(e){d.data=$.extend({},e.data[0]),n({data:e.data[0]})}})}}),t.id?o.form.load():o.form.create()},submit:t.submit})}})},657:()=>{jdoo.define("KeyValue",{new:function(){this.values=[],this.keyValue={}},add:function(e,t){this.keyValue[e]=t,this.values.push(t)},remove:function(e){var t=this,d=t.get(e);return delete t.keyValue[e],t.values.remove(d),d},get:function(e){return this.keyValue[e]},getValues:function(){return this.values},each:function(e){$.each(this.values,e)},find:function(e){var t=[];return $.each(this.values,(function(){e(this)&&t.push(this)})),t},first:function(e){var t=null;return $.each(this.values,(function(){if(e(this))return t=this,!1})),t}})},504:()=>{jdoo.component("Model",{x:"0",y:"0",getTpl:function(){let e=this,t=e.diagram.module_id===e.data.module_id?"":" other-module";return`<div id="${e.id}" data-model="${e.data.id}" class="item-model${t}" style="top:${e.y}px;left:${e.x}px;">\n                        <div class="model-meta">\n                            <div class="model-tools">\n                                <div class="nav-item dropdown">\n                                    <span data-toggle="dropdown" role="button">\n                                        <i class="fa fa-bars"></i>\n                                    </span>\n                                    <div class="dropdown-menu dropdown-menu-right">\n                                        <span role="button" class="menu-model dropdown-item">${"详情".t()}</span>\n                                        <span role="button" class="menu-code-view dropdown-item">${"生成代码".t()}</span>\n                                        <span role="button" class="menu-code-download dropdown-item">${"下载代码".t()}</span>\n                                        <span role="button" class="menu-publish dropdown-item">${"发布".t()}</span>\n                                        <div role="separator" class="dropdown-divider"></div>\n                                        <span role="button" title="${"从当前模型图移除".t()}" class="menu-unlink dropdown-item">${"移除".t()}</span>\n                                        <span role="button" title="${"删除模型".t()}" class="menu-delete dropdown-item">${"删除".t()}</span>\n                                    </div>\n                                </div>\n                                <span class="btn-edit" role="button"><i class="fa fa-pencil-alt"></i></span>\n                                <span class="btn-add-field" role="button"><i class="fa fa-plus"></i></span>\n                            </div>\n                            <div class="model-name">${e.data.name}</div>\n                            <div class="model-model">${"模型".t()}:<span>${e.data.model}</span></div>\n                            <div class="model-class">${"类名".t()}:<span>${e.data.model_class}</span></div>\n                            <div class="model-inherit" style="display:${e.data.inherit?"block":"none"}">${"继承".t()}:<span>${e.data.inherit}</span></div>\n                        </div>\n                        <div class="model-members"></div>\n                    </div>`},init:function(){let e=this;e.id=e.id||jdoo.utils.randomId(),e.canvas=$(e.renderTo),e.canvas.append(e.getTpl()),e.dom=e.canvas.find("#"+e.id),e.dom.on("click",".btn-add-field",(function(){e.diagram.createField(e.id)})).on("click",".menu-edit-field",(function(){let t=$(this).parents(".item-field").attr("id");e.diagram.editField(e.id,t)})).on("dblclick",".item-field",(function(){let t=$(this).attr("id");e.diagram.editField(e.id,t)})).on("click",".menu-delete-field",(function(){let t=$(this).parents(".item-field").attr("id");jdoo.msg.confirm({content:"确定删除字段?",submit:function(){e.diagram.deleteField(e.id,t)}})})).on("click",".menu-model",(function(){})).on("click",".menu-delete",(function(){e.delete()})).on("click",".menu-unlink",(function(){e.unlink()})).on("click",".menu-code-view",(function(){e.diagram.viewCode([e.id])})).on("click",".menu-publish",(function(){})).on("click",".btn-edit",(function(){e.diagram.editModel(e.id)})).on("dblclick",".model-meta",(function(){e.diagram.editModel(e.id)})),e.dom.draggable({scroll:!0,opacity:.8,zIndex:999,cursor:"move",containment:"parent",stack:".item-model",delay:100,start:function(t,d){e.selected||(e.diagram.unselectModels(),e.select())},drag:function(t,d){$.each(e.connectors,(function(){this.update()}));let o=d.originalPosition,n=d.position,i=e.diagram.zoom;n.left=o.left+100*(n.left-o.left)/i,n.top=o.top+100*(n.top-o.top)/i,n.left<0&&(n.left=0),n.top<0&&(n.top=0)},stop:function(t){$.each(e.connectors,(function(){this.update()}));let d={id:e.id,modelId:e.data.id,x0:e.x,y0:e.y};d.x=e.x=e.dom.css("left").replace("px",""),d.y=e.y=e.dom.css("top").replace("px",""),e.diagram.updateLocation(d)}}),e.fields=jdoo.create("KeyValue"),e.connectors=[],e.dom.find("[data-toggle=dropdown]").dropdown({boundary:e.canvas.parent()})},moveTo:function(e){let t=this;t.x=e.x,t.y=e.y,t.dom.css("left",t.x+"px").css("top",t.y+"px"),$.each(t.connectors,(function(){this.update()}))},update:function(e){let t=this;e.id!==t.data.id&&$("[data-model="+t.data.id+"]").attr("data-model",e.id),$.extend(!0,t.data,e),$("[data-model="+t.data.id+"] .model-name").html(t.data.name),$("[data-model="+t.data.id+"] .model-model span").html(t.data.model),$("[data-model="+t.data.id+"] .model-class span").html(t.data.model_class),$("[data-model="+t.data.id+"] .model-inherit span").html(t.data.inherit),t.data.inherit?$("[data-model="+t.data.id+"] .model-inherit").show():$("[data-model="+t.data.id+"] .model-inherit").hide()},addField:function(e){let t=this;e.model=t,e.renderTo=t.canvas.find("[data-model="+t.data.id+"] .model-members");let d=jdoo.create("Field",e);return t.fields.add(d.id,d),d},removeField:function(e){this.fields.remove(e),this.dom.find("#"+e).remove()},delete:function(){let e=this;jdoo.msg.confirm({content:"确定删除模型?".t(),submit:function(){e.diagram.deleteModel(e.id)}})},unlink:function(){let e=this;jdoo.msg.confirm({content:"确定从模型图移除模型?".t(),submit:function(){e.diagram.unlinkModel(e.id)}})},publish:function(){},genCode:function(){},select:function(){this.selected=!0,this.dom.addClass("selected")},unselect:function(){this.selected=!1,this.dom.removeClass("selected")}})},714:()=>{$.component("Modeling",{model:"modeling.diagram",module:"modeling",getTpl:function(){return'<aside class="left-box">\n                </aside>\n                <div class="main-box">\n                </div>'},init:function(){let e=this;e.dom.html(e.getTpl()),e.diagrams={},e.ws=e.dom.find(".main-box").JTabs({tabActived:function(t,d,o){let n=o.parent().attr("data");e.diagram=e.diagrams[n];let i=jdoo.web.getParams(window.location.hash.substring(1));i.diagram=n,window.location.hash=$.param(i);let a=jdoo.web.getParams(top.window.location.hash.substring(1));a.u&&(a.u=window.location.pathname+"#"+$.param($.extend($.param(unescape(a.u)),i)),top.window.location.hash=$.param(a))}}),e.modelEditor=jdoo.create("FormEdit",{model:"modeling.model",title:"模型".t()}),e.fieldEditor=jdoo.create("FormEdit",{model:"modeling.model.field",title:"字段".t()}),e.modules=e.dom.find(".left-box").ModuleView({designer:e,model:e.model,module:e.module});let t=jdoo.web.getParams(window.location.hash.substring(1));t.diagram&&e.loadDiagram(t.diagram)},loadDiagram:function(e){let t=this;jdoo.rpc({model:t.model,module:t.module,method:"read",args:{ids:[e],fields:["present","module_id","width","height"]},onsuccess:function(e){t.openDiagram(e.data[0])}})},openDiagram:function(e){let t=this;t.ws.openTab(e.id,{title:e.present,data:e.id,closable:!0,init:function(d){t.diagrams[e.id]=d.Diagram({id:e.id,module_id:e.module_id,modelEditor:t.modelEditor,fieldEditor:t.fieldEditor,width:e.width,height:e.height,modelChange:function(d,o){let n=t.modules.appTree.getNodeByParam("id","models-"+e.module_id,null);t.modules.loadModels(n)}})},onTabRemoved:function(e,d){$.each(d,(function(){delete t.diagrams[this]}))}})}}),$((function(){$(".model-designer").Modeling({})}))},689:()=>{$.component("ModuleView",{ztreeSetting:{view:{selectedMulti:!1},data:{key:{name:"present"}},edit:{drag:{isCopy:!0,isMove:!1,prev:!1,next:!1,inner:!1},enable:!0,removeTitle:"删除".t(),renameTitle:"重命名".t(),showRemoveBtn:function(e,t){return"diagram"===t.type||"app"===t.type||"model"===t.type},showRenameBtn:function(e,t){return"diagram"===t.type||"app"===t.type||"model"===t.type}}},getTpl:function(){return`<div class="h-100 module-view">\n                <div class="module-head">\n                    <label>应用</label>\n                    <span role="button" class="float-right btn-collapse"><i class="fas fa-bars"></i></span>\n                </div>                        \n                <div class="m-1">\n                    <div class="input-group input-group-sm">\n                        <div class="input-group-prepend">\n                            <button class="btn btn-default btn-sm btn-collespe" title="${"收起所有".t()}">\n                                <span class="fas fa-chevron-up"></span>\n                            </button>\n                            <button class="btn btn-default btn-sm btn-add" title="${"新增".t()}">\n                                <span class="fas fa-plus"></span>\n                            </button>\n                        </div>\n                        <input type="text" class="form-control input-keyword"></input>\n                        <div class="input-group-append">\n                            <div data-btn="view" class="btn btn-default btn-lookup">\n                                <span class="fa fa-search"></span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                <div class="module-panel">\n                    <div id="modulelist" class="module-list ztree"></div>\n                </div>\n            </div>\n            <div class="h-100 module-extender" style="display:none" role="button">\n                <span class="fa fa-angle-right"></span>\n            </div>`},init:function(){let e=this;e.dom.append(e.getTpl()),$.extend(!0,e.ztreeSetting,{view:{addHoverDom:function(t,d){if("models"===d.type||"diagrams"===d.type){let t=e.dom.find("#"+d.tId+"_a"),o=t.find(".btn-refresh");if(o.length>0)return void o.show();t.append('<span data-n="'+d.tId+'" title="'+"重新加载".t()+'" class="ml-1 fas fa-sync btn-refresh" ></span>')}},removeHoverDom:function(t,d){"models"!==d.type&&"diagrams"!==d.type||e.dom.find("#"+d.tId+"_a .btn-refresh").hide()}},callback:{onClick:function(t,d,o){o&&"add_diagram"===o.type?e.editDiagram(o,!0):o&&"diagram"===o.type&&e.designer.openDiagram(o)},beforeEditName:function(t,d){return"diagram"===d.type?e.editDiagram(d):"app"===d.type?e.editModule(d):"model"===d.type&&e.editModel(d),!1},beforeRemove:function(t,d){return"diagram"===d.type?e.deleteDiagram(d):"app"===d.type?e.deleteModule(d):"model"===d.type&&e.deleteModel(d),!1},beforeExpand:function(t,d){return"models"!==d.type||d.children?!("diagrams"===d.type&&!d.children)||e.loadDiagrams(d):e.loadModels(d)},beforeDrag:function(e,t){return t[0]&&"model"===t[0].type},onDrop:function(t,d,o){if(e.designer.diagram&&$(t.target).hasClass("model-canvas")){let d=100/e.designer.diagram.zoom;e.designer.diagram.linkModel({id:o[0].id,x:t.offsetX*d,y:t.offsetY*d})}}}}),e.dom.on("click",".btn-collapse",(function(){e.dom.animate({width:8},250,"linear",(function(){e.dom.find(".module-view").hide(),e.dom.find(".module-extender").show()}))})).on("click",".module-extender",(function(){$(this).hide(),e.dom.find(".module-view").show(),e.dom.animate({width:240},250,"linear")})).on("click",".btn-collespe",(function(){e.appTree&&e.appTree.expandAll(!1)})).on("click",".btn-add",(function(){e.editModule({})})).on("click",".btn-lookup",(function(){e.loadModules()})).on("click",".btn-refresh",(function(){let t=$(this).attr("data-n"),d=e.appTree.getNodeByTId(t);"models"===d.type?e.loadModels(d):"diagrams"===d.type&&e.loadDiagrams(d)})),e.dom.find(".input-keyword").on("keydown",(function(t){13===t.keyCode&&e.loadModules()})),e.loadModules()},loadModules:function(){let e=this,t=e.dom.find(".input-keyword").val(),d=[];t&&d.push(["present","like",t]),jdoo.rpc({model:e.model,module:e.module,method:"searchRelated",args:{relatedField:"module_id",options:{limit:1e4,offset:0,criteria:d,nextTest:!0,activeTest:!0,fields:["present"]}},context:{usePresent:!0},onsuccess:function(t){let d=t.data.values;$.each(d,(function(){this.iconSkin="app",this.type="app",this.children=[{present:"模型图",isParent:!0,type:"diagrams",module_id:this.id,iconSkin:"folder"},{present:"模型",isParent:!0,type:"models",id:"models-"+this.id,module_id:this.id,iconSkin:"folder"}]})),e.appTree=$.fn.zTree.init(e.dom.find(".module-list"),e.ztreeSetting,d)}})},loadModels:function(e){let t=this;return t.appTree.removeChildNodes(e),!(e.module_id&&!e.loading&&(e.loading=!0,jdoo.rpc({model:t.model,module:t.module,method:"loadModels",args:{moduleId:e.module_id,fields:["present","module_id"]},context:{usePresent:!0},onerror:function(t){jdoo.msg.error(t),e.loading=!1},onsuccess:function(d){let o=d.data;$.each(o,(function(){this.type="model",this.iconSkin="model"})),t.appTree.addNodes(e,o),e.loading=!1}}),1))},loadDiagrams:function(e){let t=this;return t.appTree.removeChildNodes(e),e.module_id&&!e.loading&&(e.loading=!0,jdoo.rpc({model:t.model,module:t.module,method:"search",args:{criteria:[["module_id","=",e.module_id]],offset:0,limit:1e4,fields:["present","module_id","width","height"]},onerror:function(t){jdoo.msg.error(t),e.loading=!1},onsuccess:function(d){let o=d.data.values;$.each(o,(function(){this.type="diagram",this.iconSkin="diagram"})),o.splice(0,0,{present:"<新建>",type:"add_diagram",iconSkin:"add-diagram"}),t.appTree.addNodes(e,o),e.loading=!1}})),!1},showDiagramDialog:function(e,t){let d=this;jdoo.showDialog({css:"",title:"模型图".t(),submitText:"保存".t(),init:function(){let o=this;o.form=o.body.JForm({cols:1,model:d.model,module:d.module,fields:e.fields,arch:e.views.form.arch,ajax:function(e,n){t.id&&jdoo.rpc({model:d.model,module:d.module,method:"read",args:{ids:[t.id],fields:o.form.getFields()},context:{usePresent:!0},onsuccess:function(e){n({data:e.data[0]})}})}}),t.id?o.form.load():o.form.create()},submit:function(){let e=this;if(e.form.valid()){e.busy(!0);let o=e.form.getData();o.module_id=t.diagramsNode.module_id,t.id?jdoo.rpc({model:d.model,module:d.module,method:"update",args:{ids:[t.id],values:o},dialog:e,onsuccess:function(n){d.ws.updateTab(t.id,o.name),d.loadDiagrams(t.diagramsNode);let i=d.designer.diagrams[t.id];i&&i.updateSize({width:o.width,height:o.height}),e.close()}}):jdoo.rpc({model:d.model,module:d.module,method:"create",args:o,dialog:e,onsuccess:function(n){d.loadDiagrams(t.diagramsNode),d.designer.openDiagram({id:n.data,module_id:o.module_id,present:o.name,width:o.width,height:o.height}),e.close()}})}}})},deleteDiagram:function(e){let t=this;jdoo.msg.confirm({content:"确定删除模型图:".t()+e.present+"?",submit:function(){jdoo.rpc({model:t.model,module:t.module,method:"delete",args:{ids:[e.id]},onsuccess:function(d){t.loadDiagrams(e.getParentNode()),jdoo.msg.show("删除成功".t())}})}})},editDiagram:function(e,t){let d=this,o={diagramsNode:e.getParentNode()};t||(o.id=e.id),d.diagramView?d.showDiagramDialog(d.diagramView,o):jdoo.rpc({model:"ir.ui.view",method:"loadView",args:{model:"modeling.diagram",type:"form"},onsuccess:function(e){d.diagramView=e.data,d.showDiagramDialog(d.diagramView,o)}})},deleteModule:function(e){let t=this;jdoo.msg.confirm({content:"确定删除应用:".t()+e.present+"?",submit:function(){jdoo.rpc({model:t.model,module:t.module,method:"deleteModule",args:{moduleId:e.id},onsuccess:function(e){t.loadModules(),jdoo.msg.show("删除成功".t())}})}})},showModuleDialog:function(e,t){let d=this;jdoo.showDialog({title:"应用".t(),submitText:"保存".t(),init:function(){let o=this;o.form=o.body.JForm({fields:e.fields,model:e.model,module:e.module,arch:e.views.form.arch,ajax:function(e,n){t.id&&jdoo.rpc({model:d.model,module:d.module,method:"searchRelated",args:{relatedField:"module_id",options:{criteria:[["id","=",t.id]],nextTest:!1,fields:o.form.getFields()}},context:{usePresent:!0},onsuccess:function(e){n({data:e.data.values[0]})}})}}),t.id?o.form.load():o.form.create()},submit:function(){let e=this;if(e.form.valid()){e.busy(!0);let o=e.form.getData();t.id?(o.id=t.id,jdoo.rpc({model:d.model,module:d.module,method:"updateModule",args:{values:o},dialog:e,onsuccess:function(t){d.loadModules(),e.close()}})):jdoo.rpc({model:d.model,module:d.module,method:"addModule",args:{values:o},dialog:e,onsuccess:function(t){d.loadModules(),e.close()}})}}})},editModule:function(e){let t=this;t.moduleView?t.showModuleDialog(t.moduleView,e):jdoo.rpc({model:"ir.ui.view",method:"loadView",args:{model:"ir.module",type:"form"},onsuccess:function(d){t.moduleView=d.data,t.showModuleDialog(t.moduleView,e)}})},deleteModel:function(e){let t=this;jdoo.msg.confirm({content:"确定删除模型:".t()+e.present+"?",submit:function(){jdoo.rpc({model:t.model,module:t.module,method:"deleteModel",args:{modelId:e.id},onsuccess:function(d){t.loadModels(e.getParentNode());for(let d in t.designer.diagrams)t.designer.diagrams[d].removeModel(e.id);jdoo.msg.showMsg("删除成功".t())}})}})},editModel:function(e){}})},271:()=>{$.component("ToolItem",{init:function(){let e=this;e.dom.draggable({scroll:!1,opacity:.8,zIndex:999,cursor:"cell",containment:e.containment||"window",cursorAt:{top:0,left:0},helper:function(e){return $(e.currentTarget).clone(!0).css({zIndex:"99999","background-color":"gray",position:"absolute","border-radius":0})},start:function(e){},drag:function(e){},stop:function(t){let d=e.diagram.canvas.offset(),o=100/e.diagram.zoom,n={x:t.pageX*o-d.left,y:t.pageY*o-d.top};e.diagram.newModel(n)}})}})}},t={};function d(o){var n=t[o];if(void 0!==n)return n.exports;var i=t[o]={exports:{}};return e[o](i,i.exports,d),i.exports}d.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return d.d(t,{a:t}),t},d.d=(e,t)=>{for(var o in t)d.o(t,o)&&!d.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},d.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";d(657),d(737),d(504),d(969),d(271),d(706),d(689),d(718),d(202),d(441),d(714)})()})();